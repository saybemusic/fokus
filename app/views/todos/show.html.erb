<div class="programmes-page fk-container">

  <div class="back-arrow" data-controller="back-arrow">
    <%= link_to "←", objective_path(@objective), class: "back-link" %>
  </div>

  <div class="fk-header">
    <h1 class="programmes-fk-title"><%= @todo.title %></h1>
    <p class="programmes-fk-subtitle"><strong>Jour :</strong> <%= @todo.to_ordered_day() %></p>
  </div>

  <h2 class="programmes-fk-subtitle">Tâches du jour</h2>

  <div class="programmes-main-card">
    <div class="programmes-cards-scroll">
      <% @todo.tasks.order(:priority).each do |task| %>
        <% if task.completed %>
          <%= link_to uncomplete_task_path(task), data: { turbo_method: :patch, turbo: true }, id: dom_id(task) do %>
            <div  class="programmes-carte" data-completed="true">
              <div class="programmes-carte-header done">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48">
                  <g fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="4">
                    <path d="M24 44a19.94 19.94 0 0 0 14.142-5.858A19.94 19.94 0 0 0 44 24a19.94 19.94 0 0 0-5.858-14.142A19.94 19.94 0 0 0 24 4A19.94 19.94 0 0 0 9.858 9.858A19.94 19.94 0 0 0 4 24a19.94 19.94 0 0 0 5.858 14.142A19.94 19.94 0 0 0 24 44Z"/>
                    <path stroke-linecap="round" d="m16 24l6 6l12-12"/>
                  </g>
                </svg>
                <p><%= task.title %></p>
              </div>
            </div>
          <% end %>
        <% else %>
          <div id="<%= dom_id(task) %>" class="programmes-carte" data-completed="false">
            <div class="programmes-carte-header pending">
              <%= link_to complete_task_path(task), data: { turbo_method: :patch, turbo: true }, class: "blanc" do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48">
                  <g fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="4">
                    <path d="M24 44a19.94 19.94 0 0 0 14.142-5.858A19.94 19.94 0 0 0 44 24a19.94 19.94 0 0 0-5.858-14.142A19.94 19.94 0 0 0 24 4A19.94 19.94 0 0 0 9.858 9.858A19.94 19.94 0 0 0 4 24a19.94 19.94 0 0 0 5.858 14.142A19.94 19.94 0 0 0 24 44Z"/>
                  </g>
                </svg>
              <% end %>
              <p><%= task.title %></p>
            </div>
            <div class="programmes-carte-body">
              <details>
                <summary>Comment faire ?</summary>
                <p><%= task.ressource_ia %></p>
              </details>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>



    <% if @objective_completed %>
      <div id="<%= dom_id(@todo, "next_todo") %>">
        <p>Bravo, vous avez atteint votre objectif !</p>
        <%= link_to "VOIR MES OBJECTIFS", objectives_path(@objective), class: "bouton" %>
      </div>
    <% else %>
      <% if @todo_just_completed %>
        <%= link_to "Passer au jour suivant", next_day_path(@todo), class: "bouton", id: dom_id(@todo, "next_todo") %>
      <% else %>
        <div id="<%= dom_id(@todo, "next_todo") %>"></div>
      <% end %>
    <% end %>

    <% @todo.tasks.each do |task| %>
      <% if task.priority == 1 && !task.completed %>
        <a href="#" class="bouton w-100 my-2 fokus-btn"
          data-bs-toggle="modal"
          data-bs-target="#fokusModal"
          data-task-name="<%= task.title %>"
          id="fokus-btn">
          FOKUS
        </a>
      <% end %>
    <% end %>
  </div>
</div>

<div class="modal fade"
     id="fokusModal"
     tabindex="-1"
     data-bs-backdrop="static"
     data-bs-keyboard="false"
     data-controller="fokus">

  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close btn-close-black" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center">
        <h5 id="fokusModalLabel">
          <span id="taskName" data-fokus-target="taskName"></span>
        </h5>

        <div class="timer-container" data-fokus-target="timerContainer">
          <%# <div id="timer" class="digital-timer" data-fokus-target="timerDisplay"> %>
            <%# 15:00 %>
          <%# </div> %>
          <svg class="analog-timer" viewBox="0 0 200 200">
            <circle cx="100" cy="100" r="85" fill="none" stroke="#e0e0e0" stroke-width="8"/>
            <circle cx="100" cy="100" r="85" fill="none" stroke="#003901" stroke-width="8"
                    stroke-linecap="round" stroke-dasharray="534" stroke-dashoffset="534"
                    data-fokus-target="progressRing"
                    style="transform: rotate(-90deg); transform-origin: 50% 50%;"/>
            <g class="clock-marks">
              <% (0..11).each do |i| %>
                <line x1="100" y1="20" x2="100" y2="35"
                      stroke="#999" stroke-width="3"
                      transform="rotate(<%= i * 30 %>, 100, 100)"
                      stroke-linecap="round"/>
              <% end %>
            </g>
            <!-- Cercle central remplacé par un conteneur <foreignObject> pour le timer numérique -->
            <foreignObject x="60" y="60" width="80" height="80">
              <div xmlns="http://www.w3.org/1999/xhtml" class="timer-center">
                <div id="timer" data-fokus-target="timerDisplay">
                </div>
              </div>
            </foreignObject>
          </svg>
        </div>

        <div class="d-flex justify-content-center gap-2 mb-3">
          <a type="button"
                  class="bouton"
                  data-fokus-target="startButton"
                  data-action="click->fokus#start">
            Démarrer
          </a>

          <a type="button"
                  class="bouton"
                  style="display: none;"
                  data-fokus-target="pauseButton"
                  data-action="click->fokus#pause">
            Pause
          </a>

          <a type="button"
                  class="bouton"
                  data-fokus-target="stopButton"
                  data-action="click->fokus#stop">
            Stop
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
